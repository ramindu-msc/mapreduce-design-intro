version: "2"
services:
  namenode:
    image: apache/hadoop:3
    platform: linux/amd64
    hostname: namenode
    container_name: namenode
    volumes:
      - ./Makefile:/opt/hadoop/Makefile
      - /Users/ramindu/iit/lecture4/mapreduce-design-intro/resources:/opt/hadoop/resources
      - /Users/ramindu/iit/lecture4/mapreduce-design-intro/hadoop-hive-dockercompose/hadoop_dir:/opt/hadoop
    ports:
      - 9870:9870
    env_file:
      - ./config
    environment:
      ENSURE_NAMENODE_DIR: "/tmp/hadoop-root/dfs/name"
      HDFS_SITE_XML_dfs.webhdfs.enabled: "true"
      CLUSTER_NAME: "test"
    command: ["hdfs", "namenode"]
    deploy:
      resources:
        limits:
          cpus: "1.5"  # limit to 1.5 CPU cores
          memory: "2g"  # limit memory to 2GB

  datanode_1:
    image: apache/hadoop:3
    platform: linux/amd64
    container_name: datanode
    command: [ "hdfs", "datanode" ]
    env_file:
      - ./config
    environment:
      - CLUSTER_NAME=test

  resourcemanager:
    image: apache/hadoop:3
    platform: linux/amd64
    hostname: resourcemanager
    container_name: resourcemanager
    command: [ "yarn", "resourcemanager" ]
    ports:
      - 8088:8088
    env_file:
      - ./config
    volumes:
      - ./test.sh:/opt/test.sh
    environment:
      - CLUSTER_NAME=test
    deploy:
      resources:
        limits:
          cpus: "1.5"  # limit to 1.5 CPU cores
          memory: "2g"  # limit memory to 2GB

  nodemanager:
    image: apache/hadoop:3
    platform: linux/amd64
    container_name: nodemanager
    command: [ "yarn", "nodemanager" ]
    env_file:
      - ./config
    environment:
      - CLUSTER_NAME=test

  mysql:
    image: mysql:5.7
    container_name: mysql
    platform: linux/amd64
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: metastore
      MYSQL_USER: hive
      MYSQL_PASSWORD: hivepassword
    ports:
      - 3306:3306
    volumes:
      - ./mysql_data:/var/lib/mysql

  hive-metastore:
    image: bde2020/hive:2.3.2-postgresql-metastore
    platform: linux/amd64
    container_name: hive-metastore
    environment:
      HIVE_METASTORE_DB_HOST: mysql
      HIVE_METASTORE_DB_PORT: 3306
      HIVE_METASTORE_DB_NAME: metastore
      HIVE_METASTORE_DB_USER: hive
      HIVE_METASTORE_DB_PASSWORD: hivepassword
    env_file:
      - ./config
    depends_on:
      - mysql
      - namenode
    ports:
      - 9083:9083
    command: /opt/hive/bin/hive --service metastore

  hive-server:
    image: bde2020/hive:2.3.2
    platform: linux/amd64
    container_name: hive-server
    environment:
      - HADOOP_HOME=/opt/hadoop  # Correct format for environment variables
      - PATH=$PATH:/opt/hadoop/bin  # Correct format for environment variables
      - HIVE_METASTORE_URI=thrift://hive-metastore:9083
    volumes:
      - /Users/ramindu/iit/lecture4/mapreduce-design-intro/hadoop-hive-dockercompose/hadoop_dir:/opt/hadoop
    env_file:
      - ./config
    depends_on:
      - hive-metastore
    ports:
      - 10000:10000
    command: /bin/bash -c "export HADOOP_HOME=/opt/hadoop && /opt/hive/bin/hiveserver2"
